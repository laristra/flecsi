#------------------------------------------------------------------------------#
# Start with plain Fedora
#------------------------------------------------------------------------------#

FROM fedora:latest

#------------------------------------------------------------------------------#
# Install Fedora packages
#------------------------------------------------------------------------------#

RUN dnf install -y \
  passwd \
  make \
  git \
  xz \
  lbzip2 \
  which \
  gcc \
  gcc-c++ \
  gcc-gfortran \
  clang \
  flex \
  patch \
  wget \
  curl \
  vim-enhanced \
  emacs-color-theme

#------------------------------------------------------------------------------#
# Set a root password
#------------------------------------------------------------------------------#

RUN echo 'flecsi' | passwd --stdin root

#------------------------------------------------------------------------------#
# Add the flecsi user
#------------------------------------------------------------------------------#

RUN groupadd -r flecsi
RUN useradd -r -m -g flecsi flecsi

USER flecsi
WORKDIR /home/flecsi

RUN \
  echo "syntax on" > .vimrc && \
  echo "set background=dark" >> .vimrc && \
  echo "highlight Comment cterm=italic" >> .vimrc

#------------------------------------------------------------------------------#
# Install flecsi and setup spack environment
#------------------------------------------------------------------------------#

USER flecsi
WORKDIR /home/flecsi

#ARG REPO
#ARG BRANCH

ARG REPO=https://github.com/tuxfan/flecsi.git
ARG BRANCH=flog-tutorial

#ARG REPO=https://github.com/laristra/flecsi.git
#ARG BRANCH=devel

RUN git clone --single-branch --branch ${BRANCH} ${REPO} .flecsi

RUN git clone --single-branch \
  --branch develop https://github.com/spack/spack.git .spack

RUN \
  source .spack/share/spack/setup-env.sh && \
  spack repo add /home/flecsi/.flecsi/spack-repo

# Call fetch to make sure that we don't fail during build
RUN \
  source .spack/share/spack/setup-env.sh && \
  spack fetch --dependencies flecsi@devel backend=legion +flog ^mpich

RUN \
  source .spack/share/spack/setup-env.sh && \
  spack install flecsi@devel backend=legion +flog ^mpich

RUN \
  source .spack/share/spack/setup-env.sh && \
  spack env create flecsi && \
  spack env activate flecsi && \
  spack install flecsi@devel backend=legion +flog ^mpich && \
  spack install cmake

RUN \
  echo ". .spack/share/spack/setup-env.sh" >> .bashrc && \
  echo "spack env activate flecsi" >> .bashrc

#------------------------------------------------------------------------------#
# Copy the tutorial code to home and build
#------------------------------------------------------------------------------#

RUN cp -r .flecsi/tutorial/* . && rm -rf docker

RUN \
  source .spack/share/spack/setup-env.sh && \
  spack env activate flecsi && \
  mkdir build && \
  cd build && \
  cmake .. && make

#------------------------------------------------------------------------------#
# Set the execution shell
#------------------------------------------------------------------------------#

CMD /bin/bash

#------------------------------------------------------------------------------#
# vim: syntax=dockerfile
#------------------------------------------------------------------------------#
