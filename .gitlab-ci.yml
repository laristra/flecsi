image: docker:latest

services:
        - docker:dind

stages:
        - build
        - test
        - deploy

before_script:
        - mkdir /builds/onurcaylak/artifacts
        - git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
        - git fetch --unshallow && git fetch --tags #for versioning

DISTRO=ubuntu RUNTIME=legion DOCKERHUB=true:
        stage: build

        variables:
          GLOBAL_CI_VARIABLE: "global_ci_value"

        #before_script:
        #Config

        script:
                - DISTRO=ubuntu RUNTIME=legion DOCKERHUB=true
                - pwd
                - cd ../
                - pwd
                - cp -vr flecsi/docker .
                - ls -la
                - sed -i "1s/fedora/${DISTRO}/" docker/Dockerfile
                - if [[ ${CC} != gcc ]]; then TAG="_${CC}"; fi
                - if [[ ${CI_COMMIT_REF_NAME} != stable ]]; then TAG="${TAG}_${CI_COMMIT_REF_NAME//\//_}"; fi
                - docker pull $(sed -n '1s/FROM //p' docker/Dockerfile)
                - docker build -t ${CI_COMMIT_REF_NAME}:${DISTRO}_${RUNTIME}${TAG} ${HOME}/docker/ --build-arg LEGION=${LEGION} --build-arg RUNTIME=${RUNTIME} /
                               --build-arg CXXFLAGS="${WERROR:+-Werror} -Wno-deprecated-declarations"/
                               --build-arg COVERAGE=${COVERAGE} --build-arg MINIMAL=${MINIMAL} /
                               --build-arg CC=${CC} --build-arg CXX=${CXX} /
                               --build-arg SONARQUBE=${SONARQUBE} --build-arg SONARQUBE_TOKEN=${SONARQUBE_TOKEN} /
                               --build-arg SONARQUBE_GITHUB_TOKEN=${SONARQUBE_GITHUB_TOKEN} /
                               --build-arg CI=${CI} --build-arg TRAVIS=${TRAVIS} --build-arg TRAVIS_OS_NAME=${DISTRO} /
                               --build-arg IGNORE_NOCI=${IGNORE_NOCI} /
                               --build-arg TRAVIS_BRANCH=${TRAVIS_BRANCH} --build-arg TRAVIS_JOB_NUMBER=${TRAVIS_JOB_NUMBER} /
                               --build-arg TRAVIS_PULL_REQUEST=${TRAVIS_PULL_REQUEST} --build-arg TRAVIS_JOB_ID=${TRAVIS_JOB_ID} /
                               --build-arg TRAVIS_TAG=${TRAVIS_TAG} --build-arg TRAVIS_REPO_SLUG=${TRAVIS_REPO_SLUG} /
                               --build-arg TRAVIS_COMMIT=${TRAVIS_COMMIT} / &&
                               CON=$(docker run -d ${CI_COMMIT_REF_NAME}:${DISTRO}_${RUNTIME}${TAG} /bin/bash) &&
                               docker cp ${CON}:/home/flecsi /builds/onurcaylak/artifacts/.

        artifacts:
                expire_in: 1 hour
                paths:
                        - /builds/onurcaylak/artifacts
                                                     
