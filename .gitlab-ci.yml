image: docker:latest

services:
        - docker:dind

stages:
        - build
        - test
        - deploy

before_script:
        - git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
        - git fetch --unshallow && git fetch --tags #for versioning

DISTRO=ubuntu RUNTIME=legion DOCKERHUB=true:
        stage: build

        variables:
          GLOBAL_CI_VARIABLE: "global_ci_value"

        before_script:
        #Config
                - export HOME=/home
                - mkdir -p ${HOME}/.ccache
                - mkdir -p ${HOME}/.sonar
                - export CCACHE_BASEDIR=${HOME}
                - export SONAR_BASEDIR=${HOME}
                - export CCACHE_DIR=${HOME}/.ccache 
                - export SONAR_DIR=${HOME}/.sonar 
                - export CC=gcc

        script:
                - DISTRO=ubuntu RUNTIME=legion DOCKERHUB=true
                - cd ${CI_PROJECT_DIR}
                - cp -vr docker ${HOME}/docker
                - sed -i "1s/fedora/${DISTRO}/" ${HOME}/docker/Dockerfile
                - cd ../../
                - cp -r  ${CI_PROJECT_PATH} $HOME/docker
                - cp -r $HOME/.ccache ${HOME}/docker/ccache
                - cp -r $HOME/.sonar ${HOME}/docker/sonar
                - if [[ ${CC} != gcc ]]; then TAG="_${CC}"; fi
                - if [[ ${CI_COMMIT_REF_NAME} != stable ]]; then TAG="${TAG}_${CI_COMMIT_REF_NAME//\//_}"; fi
                - docker pull $(sed -n '1s/FROM //p' ${HOME}/docker/Dockerfile)
                - docker build --build-arg LEGION=${LEGION} --build-arg RUNTIME=${RUNTIME} 
                               --build-arg CXXFLAGS="${WERROR:+-Werror} -Wno-deprecated-declarations"
                               --build-arg COVERAGE=${COVERAGE} --build-arg MINIMAL=${MINIMAL}
                               --build-arg CC=${CC} --build-arg CXX=${CXX}
                               --build-arg SONARQUBE=${SONARQUBE} --build-arg SONARQUBE_TOKEN=${SONARQUBE_TOKEN}


        artifacts:
                expire_in: 1 hour
                paths:
                        - /home/.sonar
                                                      
